<!DOCTYPE html>
<html lang="id">
<head>
    <title>TTS With Notif</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/bootstrapMin.css">
    <link rel="stylesheet" href="./css/style.css">
    <script src="./js/sweetalert2@11.js"></script>
    <script src="./js/runServiceWorker.js"></script>
</head>
<body>
    <div class="btnSwitch">
        <button class="switchPage" onclick="location.href='lp.html'">Switch to LP</button>
    </div>
    <div class="container mt-4">
        <h4 class="text-center">ADMIN PAGING AREA</h4>
        <audio id="notifAudio" src="./notif.mp3" preload="auto"></audio>
        <form id="dataForm">
            <div class="form-container">
                <div class="form-group">
                    <input list="nameOptions" id="nameInput" name="name" placeholder="Pilih atau Ketik Nama">
                    <datalist id="nameOptions"></datalist>
                </div>
                <div class="form-group">
                    <input list="plateOptions" id="plateInput" name="plate" placeholder="Pilih atau Ketik Plat Nomor">
                    <datalist id="plateOptions"></datalist>
                </div>
                <div class="form-group">
                    <input list="textOptions" id="textInput" name="text" placeholder="Pilih atau Ketik Text" required>
                    <datalist id="textOptions"></datalist>
                </div>
                <div class="form-group">
                    <button type="submit">Tambahkan</button>
                </div>
            </div>
        </form>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>Plat Nomor</th>
                    <th>Text Lain</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                <tr id="row1">
                    <td class="name">Budi</td>
                    <td class="plate">B 1234 CD</td>
                    <td class="otherText">Silakan parkir</td>
                    <td><button class="listen-btn" onclick="readText('row1')">Dengarkan</button></td>
                </tr>
            </tbody>
        </table>
    </div>

<script>
    window.data = [];

    function formatPlateNumber(plate) {
        return plate.toUpperCase();
    }

    function capitalizeText(text) {
        return text.replace(/\b\w/g, char => char.toUpperCase());
    }

    const notificationSound = document.getElementById('notifAudio');

    function playNotificationSound() {
        return new Promise((resolve, reject) => {
            notificationSound.play()
                .then(() => {
                    notificationSound.onended = resolve;
                })
                .catch((error) => {
                    console.log('Audio play blocked:', error);
                    reject(error);
                });
        });
    }

    function toggleListenButton(button, isDisabled) {
        if (isDisabled) {
            button.disabled = true;
            button.style.backgroundColor = 'red';
            button.innerText = 'Mendengarkan...';
        } else {
            button.style.display = 'none'; // Menghilangkan tombol setelah selesai membaca
        }
    }

    function startReadText(text) {
        const maxChunkLength = 150;
        let utterances = [];

        let words = text.split(" ");
        let chunk = "";

        for (let word of words) {
            if ((chunk + word).length > maxChunkLength) {
                utterances.push(chunk.trim());
                chunk = "";
            }
            chunk += word + " ";
        }
        if (chunk) utterances.push(chunk.trim());

        function speakChunk(index) {
            return new Promise((resolve, reject) => {
                if (index >= utterances.length) {
                    resolve();
                    return;
                }

                let utterance = new SpeechSynthesisUtterance(utterances[index]);
                utterance.lang = 'id-ID';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;

                utterance.onend = () => {
                    setTimeout(() => resolve(speakChunk(index + 1)), 500);
                };

                utterance.onerror = (event) => {
                    console.error("Error saat membaca teks:", event);
                    reject(event);
                };

                window.speechSynthesis.speak(utterance);
            });
        }

        return speakChunk(0).catch(error => console.error("Kesalahan saat membaca:", error));
    }

    function startReadingWithNotification(textToRead, button) {
        playNotificationSound()
            .then(() => {
                window.speechSynthesis.cancel();
                toggleListenButton(button, true); // Kunci tombol saat mulai membaca

                let playCount = 0;
                function readTextTwice() {
                    startReadText(textToRead)
                        .then(() => {
                            playCount++;
                            if (playCount < 2) {
                                readTextTwice();
                            } else {
                                toggleListenButton(button, false); // Hapus tombol setelah selesai membaca
                            }
                        });
                }

                readTextTwice();
                console.log(`Text yang dibaca:\n${textToRead}`);
            })
            .catch((error) => {
                console.error('Gagal memutar notifikasi:', error);
            });
    }

    function readText(rowId) {
        const row = document.getElementById(rowId);

        if (!row) {
            console.error(`Row dengan ID ${rowId} tidak ditemukan.`);
            return;
        }

        const nameElement = row.querySelector('.name');
        const plateElement = row.querySelector('.plate');
        const otherTextElement = row.querySelector('.otherText');
        const listenButton = row.querySelector('.listen-btn'); // Ambil tombol "Dengarkan"

        if (!nameElement || !plateElement || !otherTextElement || !listenButton) {
            console.error('Elemen yang dibutuhkan tidak ditemukan dalam baris ini.');
            return;
        }

        const name = nameElement.innerText.trim();
        const plate = plateElement.innerText.trim();
        const otherText = otherTextElement.innerText.trim();

        const formattedPlate = formatPlateNumber(plate);
        const formattedName = capitalizeText(name);
        const formattedOtherText = capitalizeText(otherText);

        const textToRead = `${formattedName}, ${formattedPlate}, ${formattedOtherText}`;

        startReadingWithNotification(textToRead, listenButton);
    }
</script>
<script src="./js/eventBtn.js"></script>
<script src="./js/loadConfig.js"></script>
</body>
</html>